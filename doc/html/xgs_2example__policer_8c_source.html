<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>OpenNSL API Guide and Reference Manual: examples/xgs/example_policer.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen/doxygen_brcm.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">OpenNSL API Guide and Reference Manual
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Welcome</span></a></li>
      <li><a href="pages.html"><span>OpenNSL&#160;Documentation</span></a></li>
      <li><a href="modules.html"><span>API&#160;Reference</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">examples/xgs/example_policer.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="xgs_2example__policer_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*********************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> *</span>
<a name="l00003"></a>00003 <span class="comment"> * (C) Copyright Broadcom Corporation 2013-2017</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> *  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a name="l00006"></a>00006 <span class="comment"> *  you may not use this file except in compliance with the License.</span>
<a name="l00007"></a>00007 <span class="comment"> *  You may obtain a copy of the License at</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> *      http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> *  Unless required by applicable law or agreed to in writing, software</span>
<a name="l00012"></a>00012 <span class="comment"> *  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a name="l00013"></a>00013 <span class="comment"> *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l00014"></a>00014 <span class="comment"> *  See the License for the specific language governing permissions and</span>
<a name="l00015"></a>00015 <span class="comment"> *  limitations under the License.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> **********************************************************************</span>
<a name="l00018"></a>00018 <span class="comment"> *</span>
<a name="l00019"></a>00019 <span class="comment"> * \file         example_policer.c</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief        OpenNSL example application for policer or service meter</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \details       In this example, we will create a simple two rate, three color policer. </span>
<a name="l00024"></a>00024 <span class="comment"> *                This policer will be attached to a Field Processor rule that counts </span>
<a name="l00025"></a>00025 <span class="comment"> *                packets ingressing on a selected port with a specific VLAN Id. </span>
<a name="l00026"></a>00026 <span class="comment"> *                Packets that exceed peak rate will be colored red.  A field processor </span>
<a name="l00027"></a>00027 <span class="comment"> *                stat counter will be attached that counts &quot;red&quot; and &quot;not red&quot; bytes.</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> **********************************************************************/</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;<a class="code" href="opennsl_2error_8h.html">opennsl/error.h</a>&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;<a class="code" href="opennsl_2port_8h.html">opennsl/port.h</a>&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;<a class="code" href="vlan_8h.html">opennsl/vlan.h</a>&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;<a class="code" href="field_8h.html">opennsl/field.h</a>&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;<a class="code" href="policer_8h.html">opennsl/policer.h</a>&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;<a class="code" href="examples_2util_8h.html">examples/util.h</a>&gt;</span>
<a name="l00039"></a>00039 
<a name="l00040"></a><a class="code" href="xgs_2example__policer_8c.html#adbb76aecfc5eef000cb4cb55bc2fd404">00040</a> <span class="preprocessor">#define DEFAULT_UNIT 0</span>
<a name="l00041"></a><a class="code" href="xgs_2example__policer_8c.html#a91668ed1245d073a2ac84e6121205d28">00041</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_VLAN 1</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <a class="code" href="group__error.html#gac798c5c818a3213c27d2900d47add7f9" title="OPENNSL API error codes.">opennsl_error_t</a>
<a name="l00045"></a><a class="code" href="xgs_2example__policer_8c.html#a0b1e59ebe305a08745173e74b2914ac2">00045</a> <a class="code" href="xgs_2example__policer_8c.html#a0b1e59ebe305a08745173e74b2914ac2">example_create_policer</a>(<span class="keywordtype">int</span> unit, <a class="code" href="group__field.html#ga4387a1b4682c605fcc1a2b8297f8a404" title="Opaque handle to a field group.">opennsl_field_group_t</a> * group, <a class="code" href="group__types.html#gacaeba2b4ddbc89b0e556720a9388885f" title="Set the default tag protocol ID (TPID) for the specified port.">opennsl_port_t</a> <a class="code" href="opennsl__api_8dox.html#abd1fe5382f13606db566da3450b351b0">port</a>, <a class="code" href="group__types.html#gaff94709d1708a51eb9aadb2e9fa03875" title="opennsl_vlan_t">opennsl_vlan_t</a> vlan,
<a name="l00046"></a>00046                        <span class="keywordtype">int</span> index, <span class="keywordtype">int</span> *statId)
<a name="l00047"></a>00047 {
<a name="l00048"></a>00048     <a class="code" href="group__types.html#ga265033c7aaf6d915b6aa85b49e6ecaf1" title="opennsl_field_stat_e">opennsl_field_stat_t</a> <a class="code" href="example__field__redirect_8c.html#ab30be53fb3407849f0fac2f490911c1f">stats</a>[2] = {
<a name="l00049"></a>00049         <a class="code" href="group__types.html#gga4e242bb4676be2d7083bd25738f65aafac152fc53f01d5d3ef9ec9ed7117e352e" title="Byte count of red traffic.">opennslFieldStatRedBytes</a>, <a class="code" href="group__types.html#gga4e242bb4676be2d7083bd25738f65aafaf7fdaddae89e064df8a26ad79eace4aa" title="Byte count of not red traffic.">opennslFieldStatNotRedBytes</a>
<a name="l00050"></a>00050     };
<a name="l00051"></a>00051 
<a name="l00052"></a>00052     <span class="comment">/*</span>
<a name="l00053"></a>00053 <span class="comment">     * Choose rates that don&#39;t overlap to simplify validation.  Make bit</span>
<a name="l00054"></a>00054 <span class="comment">     * rates even muliples of 8</span>
<a name="l00055"></a>00055 <span class="comment">     * */</span>
<a name="l00056"></a>00056     <span class="keyword">const</span> <span class="keywordtype">int</span>   base_rate = (index + 1) * 50;
<a name="l00057"></a>00057     <span class="keyword">const</span> <span class="keywordtype">int</span>   cir = base_rate * 8;
<a name="l00058"></a>00058     <span class="keyword">const</span> <span class="keywordtype">int</span>   cbs = (base_rate + 200) * 8;
<a name="l00059"></a>00059     <span class="keyword">const</span> <span class="keywordtype">int</span>   pir = (base_rate + 400) * 8;
<a name="l00060"></a>00060     <span class="keyword">const</span> <span class="keywordtype">int</span>   pbs = (base_rate + 600) * 8;
<a name="l00061"></a>00061 
<a name="l00062"></a>00062     <a class="code" href="group__types.html#gac91c9cde19d67513d4d7a5693f0d1fa4" title="opennsl_policer_t">opennsl_policer_t</a> <a class="code" href="dpp_2example__policer_8c.html#ae1f8e7ccbc1a30485b63b662315eb49c">policer_id</a>;
<a name="l00063"></a>00063     <a class="code" href="group__field.html#ga699caff1a232fe42e6668e5d2869e61e" title="Opaque handle to a field entry.">opennsl_field_entry_t</a> entry;
<a name="l00064"></a>00064     <a class="code" href="structopennsl__policer__config__s.html">opennsl_policer_config_t</a> policer_config;
<a name="l00065"></a>00065 
<a name="l00066"></a>00066     <span class="keywordflow">if</span> (*group &lt; 0) {
<a name="l00067"></a>00067         <span class="comment">/* Only create group once, all entries share the same group */</span>
<a name="l00068"></a>00068         <a class="code" href="structopennsl__field__qset__s.html" title="Field qset defines the set of fields used for lookup.">opennsl_field_qset_t</a> qset;
<a name="l00069"></a>00069         <span class="comment">/* Create QSET. */</span>
<a name="l00070"></a>00070         <a class="code" href="group__field.html#ga37e97efc912030850263af8ef6248443">OPENNSL_FIELD_QSET_INIT</a>(qset);
<a name="l00071"></a>00071         <span class="comment">/* Specifiy Ingress Field Processor */</span>
<a name="l00072"></a>00072         <a class="code" href="group__field.html#gae7dc7300f0a4b3add5d9099b52eaf735">OPENNSL_FIELD_QSET_ADD</a>(qset, <a class="code" href="group__field.html#ggaa519dd558cda3869447bd6e1209b8ce4a49de8bd682117312bfb61e3e63369847" title="Field Processor pipeline ingress stage.">opennslFieldQualifyStageIngress</a>);
<a name="l00073"></a>00073         <span class="comment">/* Match on outer VLAN ID and Ingress Port */</span>
<a name="l00074"></a>00074         <a class="code" href="group__field.html#gae7dc7300f0a4b3add5d9099b52eaf735">OPENNSL_FIELD_QSET_ADD</a>(qset, <a class="code" href="group__field.html#ggaa519dd558cda3869447bd6e1209b8ce4a1153c398cdfe1272094470cad2e7d8ff" title="Outer VLAN Id.">opennslFieldQualifyOuterVlanId</a>);
<a name="l00075"></a>00075         <a class="code" href="group__field.html#gae7dc7300f0a4b3add5d9099b52eaf735">OPENNSL_FIELD_QSET_ADD</a>(qset, <a class="code" href="group__field.html#ggaa519dd558cda3869447bd6e1209b8ce4a29ca6721093c1a745c509af76211a973" title="Single Input Port.">opennslFieldQualifyInPort</a>);
<a name="l00076"></a>00076 
<a name="l00077"></a>00077         <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(<a class="code" href="group__field.html#gac08a5398598caf186f4e084493431245" title="Create a field group.">opennsl_field_group_create</a>
<a name="l00078"></a>00078                             (unit, qset, <a class="code" href="group__field.html#ga650a60a6b7159e9aaa653f7e0f17c07a">OPENNSL_FIELD_GROUP_PRIO_ANY</a>, group));
<a name="l00079"></a>00079     }
<a name="l00080"></a>00080 
<a name="l00081"></a>00081     <span class="comment">/* Create a field processor entry */</span>
<a name="l00082"></a>00082     <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(<a class="code" href="group__field.html#gac6491132b08dde21c8a22ef703744d8e" title="Create a blank field entry.">opennsl_field_entry_create</a>(unit, *group, &amp;entry));
<a name="l00083"></a>00083 
<a name="l00084"></a>00084     <span class="comment">/* Match on Ingress port and VLAN ID */</span>
<a name="l00085"></a>00085     <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(<a class="code" href="group__field.html#gaca3713492d04ba13a63f373ba7e402a9">opennsl_field_qualify_InPort</a>(unit, entry, port, 0xFF));
<a name="l00086"></a>00086     <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(<a class="code" href="group__field.html#ga45af7e7b738d4b2215b3fac7098175f5">opennsl_field_qualify_OuterVlanId</a>(unit, entry, vlan, 0xFFF));
<a name="l00087"></a>00087 
<a name="l00088"></a>00088     <span class="comment">/* Fill out policer configuration */</span>
<a name="l00089"></a>00089     <a class="code" href="group__policer.html#ga91761860f3bc8d45c400f0df15c5ebb8" title="Initialize a policer configuration structure.">opennsl_policer_config_t_init</a>(&amp;policer_config);
<a name="l00090"></a>00090     policer_config.<a class="code" href="structopennsl__policer__config__s.html#ad68ece54793c13998c4fbc57da4c9f1d" title="Policer mode.">mode</a> = <a class="code" href="group__policer.html#gga4f914affbe1d6b845ee39c41ef2decd0afbbead3c313396de8c33b9174289966c" title="RFC 2698.">opennslPolicerModeTrTcm</a>;  <span class="comment">/* Two rate, three color policer */</span>
<a name="l00091"></a>00091     policer_config.<a class="code" href="structopennsl__policer__config__s.html#ad0d2de6c96152e2b0e39cbcdc68be309" title="OPENNSL_POLICER_* Flags.">flags</a> |= <a class="code" href="group__policer.html#gac31e391cb2ba0da2c59d34363c7e2537">OPENNSL_POLICER_COLOR_BLIND</a>;    <span class="comment">/* Ignore previous color */</span>
<a name="l00092"></a>00092     policer_config.<a class="code" href="structopennsl__policer__config__s.html#a0234c298242cb9c97edf38839cee39e2" title="Committed rate (kbits per sec).">ckbits_sec</a> = cir;    <span class="comment">/* Committed Rate, below this rate, packets are green */</span>
<a name="l00093"></a>00093     policer_config.<a class="code" href="structopennsl__policer__config__s.html#a6192654a85f674180fa00e496f21cbb2" title="Committed burst size (kbits).">ckbits_burst</a> = cbs;
<a name="l00094"></a>00094     policer_config.<a class="code" href="structopennsl__policer__config__s.html#a80e682a7afedf1b826cc59c632576264" title="Peak rate (kbits per sec).">pkbits_sec</a> = pir;    <span class="comment">/* Peak Rate, below rate is yellow, above rate is red */</span>
<a name="l00095"></a>00095     policer_config.<a class="code" href="structopennsl__policer__config__s.html#a45403bdbdaa193dfb2d2d872dcb65b33" title="Peak burst size (kbits).">pkbits_burst</a> = pbs;
<a name="l00096"></a>00096 
<a name="l00097"></a>00097     <span class="comment">/* Create the policer */</span>
<a name="l00098"></a>00098     <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(<a class="code" href="group__policer.html#gac1d0dc00c9ebbf0a1b263ded965e9915" title="Create a policer entry.">opennsl_policer_create</a>(unit, &amp;policer_config, &amp;policer_id));
<a name="l00099"></a>00099 
<a name="l00100"></a>00100     <span class="comment">/* Attach policer to the entry */</span>
<a name="l00101"></a>00101     <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(<a class="code" href="group__field.html#gad260788b3efb1eae8ff7f5e434767e87" title="Attach a policer to a field entry.">opennsl_field_entry_policer_attach</a>(unit, entry, 0, policer_id));
<a name="l00102"></a>00102 
<a name="l00103"></a>00103     <span class="comment">/* Add an FP rule to drop all red packets */</span>
<a name="l00104"></a>00104     <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(<a class="code" href="group__field.html#gab08abe643c27e9880d28748202969035" title="Add an action to a field entry.">opennsl_field_action_add</a>(unit, entry, <a class="code" href="group__field.html#gga7e4b15dc0ad1411548bfbaff998cb97fa9ab45b53a8bc5eb6272ba91f56918ada" title="Red Priority Drop.">opennslFieldActionRpDrop</a>, 0, 0));
<a name="l00105"></a>00105 
<a name="l00106"></a>00106     <span class="comment">/* Create a statistics entry to keep track of red/not-red traffic */</span>
<a name="l00107"></a>00107     <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(<a class="code" href="group__field.html#gadc2ef828fbcc2da29f478a7b5990ddf2" title="Create stat collection entity.">opennsl_field_stat_create</a>(unit, *group, 2, stats, statId));
<a name="l00108"></a>00108     <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(<a class="code" href="group__field.html#gad262135567b2fd47ceb1af7b4ca5c620" title="Attach statistics entity to Field Processor entry.">opennsl_field_entry_stat_attach</a>(unit, entry, *statId));
<a name="l00109"></a>00109 
<a name="l00110"></a>00110     <span class="comment">/* Finally install the field entry */</span>
<a name="l00111"></a>00111     <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(<a class="code" href="group__field.html#ga32de64a448e1706862ad27111610c718" title="Install a field entry into the hardware tables.">opennsl_field_entry_install</a>(unit, entry));
<a name="l00112"></a>00112 
<a name="l00113"></a>00113     printf
<a name="l00114"></a>00114       (<span class="stringliteral">&quot;  Policer %2d, Stat: %2d; CIR: %5d[%4d]; CBS: %5d[%4d]; PIR: %5d[%4d]; PBS: %5d[%4d]\n&quot;</span>,
<a name="l00115"></a>00115        policer_id, *statId, cir, cir / 8, cbs, cbs / 8, pir, pir / 8, pbs, pbs / 8);
<a name="l00116"></a>00116     <span class="keywordflow">return</span> <a class="code" href="group__error.html#ggab4c007d9d8465756b8f672c33764e6d5a549cc71e16fe086c0311d03bc995a11b">OPENNSL_E_NONE</a>;
<a name="l00117"></a>00117 }
<a name="l00118"></a>00118 <span class="comment">/* __doxy_func_body_end__ */</span>
<a name="l00119"></a>00119 
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 <span class="comment">/* Check Policer Rates</span>
<a name="l00122"></a>00122 <span class="comment"> *</span>
<a name="l00123"></a>00123 <span class="comment"> * This function attempts to compute actual data rates from policers defined</span>
<a name="l00124"></a>00124 <span class="comment"> * above. The assumption is that all ports are oversubscribed and that all</span>
<a name="l00125"></a>00125 <span class="comment"> * policer peak rates will be exceeded resulting in traffic shaping. The</span>
<a name="l00126"></a>00126 <span class="comment"> * computed rates are checked against expected rates. If the overall error</span>
<a name="l00127"></a>00127 <span class="comment"> * exceeds a empirically determined limit, an error status is returned.</span>
<a name="l00128"></a>00128 <span class="comment"> */</span>
<a name="l00129"></a>00129 <a class="code" href="group__error.html#gac798c5c818a3213c27d2900d47add7f9" title="OPENNSL API error codes.">opennsl_error_t</a>
<a name="l00130"></a><a class="code" href="xgs_2example__policer_8c.html#a17f27a5105da0bf18a416f4bd047cdd1">00130</a> <a class="code" href="xgs_2example__policer_8c.html#a17f27a5105da0bf18a416f4bd047cdd1">example_check_rates</a>(<span class="keywordtype">int</span> unit, <span class="keywordtype">int</span> *stat_list, <span class="keywordtype">int</span> stat_count)
<a name="l00131"></a>00131 {
<a name="l00132"></a>00132     <span class="keyword">const</span> <span class="keywordtype">int</span>   max_error = 50; <span class="comment">/* 1/2 of 1% */</span>
<a name="l00133"></a>00133     <span class="keyword">const</span> <span class="keywordtype">int</span>   loop_count = 15;
<a name="l00134"></a>00134     <span class="keywordtype">int</span>         loop;
<a name="l00135"></a>00135     <span class="keywordtype">int</span>         accumulated_error = 0;
<a name="l00136"></a>00136 
<a name="l00137"></a>00137     <span class="keywordflow">for</span> (loop = 0; loop &lt; loop_count; loop++) {
<a name="l00138"></a>00138         <span class="keywordtype">int</span>         idx;
<a name="l00139"></a>00139         <span class="keyword">const</span> <span class="keywordtype">int</span>   delay = 2;
<a name="l00140"></a>00140         <a class="code" href="sal_2types_8h.html#aa3ad64cf41ec3a042bd92550cc6ed308">uint64</a>      stat_value;
<a name="l00141"></a>00141 
<a name="l00142"></a>00142         sleep(delay);
<a name="l00143"></a>00143         printf(<span class="stringliteral">&quot;\nLoop: %d\n&quot;</span>, loop);
<a name="l00144"></a>00144         <span class="keywordflow">for</span> (idx = 0; idx &lt; stat_count; idx++) {
<a name="l00145"></a>00145             <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(<a class="code" href="group__field.html#gaf85528d51ba145198ff9be30d597814a" title="Get 64-bit counter value for specific statistic type.">opennsl_field_stat_get</a>
<a name="l00146"></a>00146                                 (unit, stat_list[idx], <a class="code" href="group__types.html#gga4e242bb4676be2d7083bd25738f65aafaf7fdaddae89e064df8a26ad79eace4aa" title="Byte count of not red traffic.">opennslFieldStatNotRedBytes</a>,
<a name="l00147"></a>00147                                  &amp;stat_value));
<a name="l00148"></a>00148             <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(<a class="code" href="group__field.html#ga6ada52ae06e1129c76b525e8ba934faf" title="Set 64-bit counter value for specific statistic type.">opennsl_field_stat_set</a>
<a name="l00149"></a>00149                                 (unit, stat_list[idx], <a class="code" href="group__types.html#gga4e242bb4676be2d7083bd25738f65aafaf7fdaddae89e064df8a26ad79eace4aa" title="Byte count of not red traffic.">opennslFieldStatNotRedBytes</a>, 0));
<a name="l00150"></a>00150             <span class="comment">/* First time around seems to always be off */</span>
<a name="l00151"></a>00151             <span class="keywordflow">if</span> (loop &gt; 0) {
<a name="l00152"></a>00152                 <span class="keyword">const</span> <a class="code" href="sal_2types_8h.html#a2777f33e5e41fad928028a58e3c0a8d8">int64</a>   expected_rate = (((idx + 1) * 50) + 400) * 1000;
<a name="l00153"></a>00153                 <span class="keyword">const</span> <a class="code" href="sal_2types_8h.html#a2777f33e5e41fad928028a58e3c0a8d8">int64</a>   rate = stat_value / delay;
<a name="l00154"></a>00154                 <span class="comment">/* LSB= 0.01% */</span>
<a name="l00155"></a>00155                 <a class="code" href="sal_2types_8h.html#a2777f33e5e41fad928028a58e3c0a8d8">int64</a>         rate_error =
<a name="l00156"></a>00156                   ((rate - expected_rate) * 10000) / expected_rate;
<a name="l00157"></a>00157 
<a name="l00158"></a>00158                 printf(<span class="stringliteral">&quot;Rate: %d = %8llu bytes/sec [expected=%8llu, error=%lld]\n&quot;</span>,
<a name="l00159"></a>00159                            stat_list[idx], rate, expected_rate, rate_error);
<a name="l00160"></a>00160                 accumulated_error += (rate_error &lt; 0) ? -rate_error : rate_error;
<a name="l00161"></a>00161             }
<a name="l00162"></a>00162         }
<a name="l00163"></a>00163     }
<a name="l00164"></a>00164     accumulated_error /= (stat_count * (loop_count - 1));
<a name="l00165"></a>00165     <span class="keywordflow">if</span> (accumulated_error &gt; max_error) {
<a name="l00166"></a>00166         printf(<span class="stringliteral">&quot;FAIL: Per port avg error %d exceeds max of %d [LSB = 0.01%%]\n&quot;</span>,
<a name="l00167"></a>00167                    accumulated_error, max_error);
<a name="l00168"></a>00168         <span class="keywordflow">return</span> <a class="code" href="group__error.html#ggab4c007d9d8465756b8f672c33764e6d5acc22c36dedd5356dfbbf50d38397cca5">OPENNSL_E_FAIL</a>;
<a name="l00169"></a>00169     }
<a name="l00170"></a>00170     printf(<span class="stringliteral">&quot;PASS: Per port avg error: +/- %d [LSB = 0.01%%]\n&quot;</span>, accumulated_error);
<a name="l00171"></a>00171     <span class="keywordflow">return</span> <a class="code" href="group__error.html#ggab4c007d9d8465756b8f672c33764e6d5a549cc71e16fe086c0311d03bc995a11b">OPENNSL_E_NONE</a>;
<a name="l00172"></a>00172 }
<a name="l00173"></a>00173 <span class="comment">/* __doxy_func_body_end__ */</span>
<a name="l00174"></a>00174 
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 <span class="comment">/* Transmit a single test packet on the specified port */</span>
<a name="l00177"></a>00177 <span class="keyword">static</span> <a class="code" href="group__error.html#gac798c5c818a3213c27d2900d47add7f9" title="OPENNSL API error codes.">opennsl_error_t</a>
<a name="l00178"></a>00178 example_tx_pkt(<span class="keywordtype">int</span> unit, <span class="keywordtype">int</span> <a class="code" href="opennsl__api_8dox.html#abd1fe5382f13606db566da3450b351b0">port</a>)
<a name="l00179"></a>00179 {
<a name="l00180"></a>00180     <a class="code" href="sal_2types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>       mypkt[] = {
<a name="l00181"></a>00181 
<a name="l00182"></a>00182 <span class="comment">/*</span>
<a name="l00183"></a>00183 <span class="comment">  00    01    02    03    04    05    06    07    08    09    10    11    12    13    14    15*/</span>
<a name="l00184"></a>00184 0x01, 0x00, 0x5E, 0x00, 0x00, 0x01, 0x80, 0x80, 0x80, 0x71, 0x35, 0x42, 0x81, 0x00, 0x00, 0x01,
<a name="l00185"></a>00185 0x08, 0x00, 0x45, 0x00, 0x00, 0x5A, 0x00, 0x01, 0x00, 0x00, 0x40, 0x11, 0xD7, 0xE6, 0xC0, 0xA8,
<a name="l00186"></a>00186 0x01, 0x01, 0xE0, 0x01, 0x01, 0x01, 0x00, 0x07, 0x00, 0x07, 0x00, 0x46, 0x2C, 0xF6, 0x41, 0x6C,
<a name="l00187"></a>00187 0x6C, 0x20, 0x47, 0x6F, 0x6F, 0x64, 0x20, 0x54, 0x68, 0x69, 0x6E, 0x67, 0x73, 0x20, 0x43, 0x6F,
<a name="l00188"></a>00188 0x6D, 0x65, 0x20, 0x54, 0x6F, 0x20, 0x54, 0x68, 0x6F, 0x73, 0x65, 0x20, 0x57, 0x68, 0x6F, 0x20,
<a name="l00189"></a>00189 0x57, 0x61, 0x6E, 0x74, 0x20, 0x4C, 0x6F, 0x74, 0x73, 0x20, 0x4F, 0x66, 0x20, 0x47, 0x6F, 0x6F,
<a name="l00190"></a>00190 0x64, 0x20, 0x54, 0x68, 0x69, 0x6E, 0x67, 0x73, 0x00, 0x00, 0x00, 0x00
<a name="l00191"></a>00191     };
<a name="l00192"></a>00192     <span class="keyword">const</span> <span class="keywordtype">int</span>   mypkt_SIZEOF = <span class="keyword">sizeof</span>(mypkt);
<a name="l00193"></a>00193     <a class="code" href="structopennsl__pkt__s.html" title="Initialize a OPENNSL packet structure.">opennsl_pkt_t</a>  *pkt;
<a name="l00194"></a>00194 
<a name="l00195"></a>00195     <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(<a class="code" href="group__pkt.html#ga47a42ca3b1affa6979707e70007122ea" title="Allocate or deallocate a packet structure and packet data.">opennsl_pkt_alloc</a>(unit, mypkt_SIZEOF, 0, &amp;pkt));
<a name="l00196"></a>00196     <a class="code" href="group__pkt.html#ga9acefb6d4b56d5988e9f43fc20375c98" title="Copy data into the data blocks of a packet structure.">opennsl_pkt_memcpy</a>(pkt, 0, mypkt, mypkt_SIZEOF);
<a name="l00197"></a>00197     pkt-&gt;<a class="code" href="structopennsl__pkt__s.html#a677cfa60b3e1be38bd8c32c2ba1011de" title="Pointer to array of data blocks.">pkt_data</a>-&gt;<a class="code" href="structopennsl__pkt__blk__s.html#a8bceb369dcb292d14e89abbe00498215">len</a> = mypkt_SIZEOF;
<a name="l00198"></a>00198     pkt-&gt;<a class="code" href="structopennsl__pkt__s.html#a601064f20f8473a03dd86240cfe6a6b4" title="OPENNSL_PKT_F_xxx flags.">flags</a> = <a class="code" href="group__pkt.html#ga13adb16515eacbaed2854ef69b3333c8" title="Regenerate CRC.">OPENNSL_TX_CRC_REGEN</a>;
<a name="l00199"></a>00199     <a class="code" href="group__types.html#ga30669bfc9d489739887018a57be1583c">OPENNSL_PBMP_PORT_SET</a>(pkt-&gt;<a class="code" href="structopennsl__pkt__s.html#a8b6b570196647c6e2c6ab5ad401c96db" title="Target ports.">tx_pbmp</a>, port);
<a name="l00200"></a>00200 
<a name="l00201"></a>00201     <span class="comment">/* Transmit packet */</span>
<a name="l00202"></a>00202     <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(<a class="code" href="group__pkt.html#ga967e993e7903a64d2a170f23b8f6c7ba" title="Transmit one or more packets.">opennsl_tx</a>(unit, pkt, <a class="code" href="sal_2types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>));
<a name="l00203"></a>00203 
<a name="l00204"></a>00204     <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(<a class="code" href="group__pkt.html#gaad1aa79d4ef9907edc9ab6b30f6a0b0f" title="Allocate or deallocate a packet structure and packet data.">opennsl_pkt_free</a>(unit, pkt));
<a name="l00205"></a>00205     <span class="keywordflow">return</span> <a class="code" href="group__error.html#ggab4c007d9d8465756b8f672c33764e6d5a549cc71e16fe086c0311d03bc995a11b">OPENNSL_E_NONE</a>;
<a name="l00206"></a>00206 }
<a name="l00207"></a>00207 <span class="comment">/* __doxy_func_body_end__ */</span>
<a name="l00208"></a>00208 
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 <span class="comment">/* Create VLAN (if necessary) and add a port to it.</span>
<a name="l00211"></a>00211 <span class="comment"> * Strip VLAN tags on egressing traffic.</span>
<a name="l00212"></a>00212 <span class="comment"> */</span>
<a name="l00213"></a>00213 <span class="keyword">static</span> <a class="code" href="group__error.html#gac798c5c818a3213c27d2900d47add7f9" title="OPENNSL API error codes.">opennsl_error_t</a>
<a name="l00214"></a>00214 example_add_port_to_vlan(<span class="keywordtype">int</span> unit, <a class="code" href="group__types.html#gaff94709d1708a51eb9aadb2e9fa03875" title="opennsl_vlan_t">opennsl_vlan_t</a> vlan, <a class="code" href="group__types.html#gacaeba2b4ddbc89b0e556720a9388885f" title="Set the default tag protocol ID (TPID) for the specified port.">opennsl_port_t</a> port)
<a name="l00215"></a>00215 {
<a name="l00216"></a>00216     <a class="code" href="struct__shr__pbmp.html">opennsl_pbmp_t</a>  untagged;;
<a name="l00217"></a>00217     <a class="code" href="struct__shr__pbmp.html">opennsl_pbmp_t</a>  port_mask;
<a name="l00218"></a>00218     <a class="code" href="group__error.html#gac798c5c818a3213c27d2900d47add7f9" title="OPENNSL API error codes.">opennsl_error_t</a> rv;
<a name="l00219"></a>00219 
<a name="l00220"></a>00220     <span class="keywordflow">if</span> (<a class="code" href="group__error.html#ga655eb72518850235a4c759ddceb622e6">OPENNSL_FAILURE</a>(rv = <a class="code" href="group__vlan.html#ga4db9e633ba9c276064768d1718c3062c" title="Allocate and configure a VLAN on the OPENNSL device.">opennsl_vlan_create</a>(unit, vlan)) &amp;&amp; (rv != <a class="code" href="group__error.html#ggab4c007d9d8465756b8f672c33764e6d5ad03e135eecd46c9c1280e7b3f6ab5b6a">OPENNSL_E_EXISTS</a>)) {
<a name="l00221"></a>00221         printf(<span class="stringliteral">&quot;Failed to create VLAN %d\n&quot;</span>, vlan);
<a name="l00222"></a>00222         <span class="keywordflow">return</span> rv;
<a name="l00223"></a>00223     }
<a name="l00224"></a>00224     <a class="code" href="group__types.html#ga30669bfc9d489739887018a57be1583c">OPENNSL_PBMP_PORT_SET</a>(port_mask, port);
<a name="l00225"></a>00225     <a class="code" href="group__types.html#ga30669bfc9d489739887018a57be1583c">OPENNSL_PBMP_PORT_SET</a>(untagged, port);
<a name="l00226"></a>00226     <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(<a class="code" href="group__vlan.html#ga1e7cecaf6718cd174f1b1aef29349340" title="Add ports to the specified VLAN.">opennsl_vlan_port_add</a>(unit, vlan, port_mask, untagged));
<a name="l00227"></a>00227     <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(<a class="code" href="group__port.html#gaa3747d513cfc9205b8ee738cba1910c1" title="Get or set the default VLAN for packets that ingress untagged.">opennsl_port_untagged_vlan_set</a>(unit, port, vlan));
<a name="l00228"></a>00228     <span class="keywordflow">return</span> <a class="code" href="group__error.html#ggab4c007d9d8465756b8f672c33764e6d5a549cc71e16fe086c0311d03bc995a11b">OPENNSL_E_NONE</a>;
<a name="l00229"></a>00229 }
<a name="l00230"></a>00230 <span class="comment">/* __doxy_func_body_end__ */</span>
<a name="l00231"></a>00231 
<a name="l00232"></a>00232 
<a name="l00233"></a>00233 <span class="comment">/*</span>
<a name="l00234"></a>00234 <span class="comment"> * This function configures two ports to feed back on each other when a packet</span>
<a name="l00235"></a>00235 <span class="comment"> * is sent on either one of them. This causes a &quot;packet storm&quot; on these two</span>
<a name="l00236"></a>00236 <span class="comment"> * ports resulting in a high rate of traffic on these ports.</span>
<a name="l00237"></a>00237 <span class="comment"> *</span>
<a name="l00238"></a>00238 <span class="comment"> * The traffic from the storm ports is used to generate traffic on other</span>
<a name="l00239"></a>00239 <span class="comment"> * ports. These ports will be configued such that ingressing traffic is</span>
<a name="l00240"></a>00240 <span class="comment"> * assigned to a unique VLAN. Policers will be created for these other ports</span>
<a name="l00241"></a>00241 <span class="comment"> * (called ingress ports).</span>
<a name="l00242"></a>00242 <span class="comment"> */</span>
<a name="l00243"></a><a class="code" href="xgs_2example__policer_8c.html#aee65dafdf707088d43b1664bf7afeb23">00243</a> <span class="keywordtype">int</span> <a class="code" href="xgs_2example__policer_8c.html#aee65dafdf707088d43b1664bf7afeb23">example_policer_test</a>(<span class="keywordtype">int</span> unit)
<a name="l00244"></a>00244 {
<a name="l00245"></a>00245     <span class="keyword">const</span> <a class="code" href="group__types.html#gaff94709d1708a51eb9aadb2e9fa03875" title="opennsl_vlan_t">opennsl_vlan_t</a> vlan_base = 100;
<a name="l00246"></a>00246     <span class="keyword">const</span> <span class="keywordtype">int</span>   max_ports = 10;
<a name="l00247"></a>00247     <span class="keyword">const</span> <span class="keywordtype">int</span>   storm_ports = 2;
<a name="l00248"></a>00248 
<a name="l00249"></a>00249     <a class="code" href="group__field.html#ga4387a1b4682c605fcc1a2b8297f8a404" title="Opaque handle to a field group.">opennsl_field_group_t</a> group = -1;
<a name="l00250"></a>00250     <a class="code" href="structopennsl__port__config__s.html" title="Port Configuration structure.">opennsl_port_config_t</a> portConfig;
<a name="l00251"></a>00251     <a class="code" href="group__types.html#gacaeba2b4ddbc89b0e556720a9388885f" title="Set the default tag protocol ID (TPID) for the specified port.">opennsl_port_t</a>  ingress_list[max_ports];
<a name="l00252"></a>00252     <a class="code" href="group__types.html#gacaeba2b4ddbc89b0e556720a9388885f" title="Set the default tag protocol ID (TPID) for the specified port.">opennsl_port_t</a>  <a class="code" href="opennsl__api_8dox.html#abd1fe5382f13606db566da3450b351b0">port</a>;
<a name="l00253"></a>00253     <a class="code" href="group__types.html#gacaeba2b4ddbc89b0e556720a9388885f" title="Set the default tag protocol ID (TPID) for the specified port.">opennsl_port_t</a>  port_list[max_ports];
<a name="l00254"></a>00254     <span class="keywordtype">int</span>         ingress_count;
<a name="l00255"></a>00255     <span class="keywordtype">int</span>         port_count;
<a name="l00256"></a>00256     <span class="keywordtype">int</span>         stat_ids[max_ports];
<a name="l00257"></a>00257 
<a name="l00258"></a>00258     port_count = 0;
<a name="l00259"></a>00259     ingress_count = 0;
<a name="l00260"></a>00260     <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(<a class="code" href="group__port.html#ga9f95e3f27b53970914dccc70ffbe7010" title="Retrieved the port configuration for the specified device.">opennsl_port_config_get</a>(unit, &amp;portConfig));
<a name="l00261"></a>00261     <a class="code" href="group__types.html#ga742e22658005a7f2772423ba8af9077d">OPENNSL_PBMP_ITER</a>(portConfig.<a class="code" href="structopennsl__port__config__s.html#afc418db09422234cc8de20841fa71f86" title="Mask of eth ports.">e</a>, port) {
<a name="l00262"></a>00262         <span class="keywordflow">if</span> (port_count == max_ports) {
<a name="l00263"></a>00263             <span class="keywordflow">break</span>;
<a name="l00264"></a>00264         }
<a name="l00265"></a>00265         port_list[port_count] = <a class="code" href="opennsl__api_8dox.html#abd1fe5382f13606db566da3450b351b0">port</a>;
<a name="l00266"></a>00266         <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(<a class="code" href="group__port.html#ga7f235353d2db2367145287133a36bf5d" title="Set or retrieve the current loopback mode of a port.">opennsl_port_loopback_set</a>(unit, port, <a class="code" href="group__port.html#gga36f69e191f72602a5bf455b195b0a18ba453094489574b462b0024d39031e17f4">OPENNSL_PORT_LOOPBACK_MAC</a>));
<a name="l00267"></a>00267         <span class="keywordflow">if</span> (port_count &gt;= storm_ports) {
<a name="l00268"></a>00268             <a class="code" href="group__types.html#gaff94709d1708a51eb9aadb2e9fa03875" title="opennsl_vlan_t">opennsl_vlan_t</a>  next_vlan = (port_count &gt;&gt; 1) + vlan_base;
<a name="l00269"></a>00269             <span class="comment">/*</span>
<a name="l00270"></a>00270 <span class="comment">             * Once storm ports are configured, configure test port pairs</span>
<a name="l00271"></a>00271 <span class="comment">             * (ingress and egress). Each port in the pair will be assigned</span>
<a name="l00272"></a>00272 <span class="comment">             * to a VLAN. Untagged packets on these ports will be assigned</span>
<a name="l00273"></a>00273 <span class="comment">             * to the new VLAN. The egress port only belongs to the new</span>
<a name="l00274"></a>00274 <span class="comment">             * VLAN. The ingress port belongs to both the new VLAN and the</span>
<a name="l00275"></a>00275 <span class="comment">             * default VLAN. This allows it to receive all traffic broadcast</span>
<a name="l00276"></a>00276 <span class="comment">             * on the default VLAN from the storm ports. The egress port is</span>
<a name="l00277"></a>00277 <span class="comment">             * configured to drop all packets to prevent packet storms on</span>
<a name="l00278"></a>00278 <span class="comment">             * these port pairs.</span>
<a name="l00279"></a>00279 <span class="comment">             */</span>
<a name="l00280"></a>00280             <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(example_add_port_to_vlan(unit, next_vlan, port));
<a name="l00281"></a>00281             <span class="keywordflow">if</span> (port_count &amp; 1) {
<a name="l00282"></a>00282                 <a class="code" href="struct__shr__pbmp.html">opennsl_pbmp_t</a>  port_mask;
<a name="l00283"></a>00283 
<a name="l00284"></a>00284                 <a class="code" href="group__types.html#ga30669bfc9d489739887018a57be1583c">OPENNSL_PBMP_PORT_SET</a>(port_mask, port);
<a name="l00285"></a>00285                 <span class="comment">/* Remove egress port from default VLAN */</span>
<a name="l00286"></a>00286                 <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(<a class="code" href="group__vlan.html#ga4b7573f64e9926a3d374014c58e84953" title="Remove ports from a specified VLAN.">opennsl_vlan_port_remove</a>(unit, 1, port_mask));
<a name="l00287"></a>00287             } <span class="keywordflow">else</span> {
<a name="l00288"></a>00288                 <span class="comment">/* Set policer on ingress port */</span>
<a name="l00289"></a>00289                 printf(<span class="stringliteral">&quot;Ingress Test Port: %d\n&quot;</span>, port);
<a name="l00290"></a>00290                 <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(<a class="code" href="xgs_2example__policer_8c.html#a0b1e59ebe305a08745173e74b2914ac2">example_create_policer</a>
<a name="l00291"></a>00291                                     (unit, &amp;group, port, next_vlan,
<a name="l00292"></a>00292                                      ingress_count, &amp;stat_ids[ingress_count]));
<a name="l00293"></a>00293                 ingress_list[ingress_count] = <a class="code" href="opennsl__api_8dox.html#abd1fe5382f13606db566da3450b351b0">port</a>;
<a name="l00294"></a>00294                 ingress_count++;
<a name="l00295"></a>00295             }
<a name="l00296"></a>00296         }
<a name="l00297"></a>00297         port_count++;
<a name="l00298"></a>00298     }
<a name="l00299"></a>00299     <span class="keywordflow">if</span> (port_count != max_ports) {
<a name="l00300"></a>00300         printf(<span class="stringliteral">&quot;Not enough ethernet ports for test: %d\n&quot;</span>, port_count);
<a name="l00301"></a>00301     }
<a name="l00302"></a>00302 
<a name="l00303"></a>00303     printf(<span class="stringliteral">&quot;Send packet on storm port %d\n&quot;</span>, port_list[0]);
<a name="l00304"></a>00304     <span class="comment">/* Create a packet storm to fully subscribe all ports being tested */</span>
<a name="l00305"></a>00305     <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(example_tx_pkt(unit, port_list[0]));
<a name="l00306"></a>00306     <a class="code" href="group__error.html#gaa1ed0c76c2846d4d337b3157ff73c823">OPENNSL_IF_ERROR_RETURN</a>(<a class="code" href="xgs_2example__policer_8c.html#a17f27a5105da0bf18a416f4bd047cdd1">example_check_rates</a>(unit, stat_ids, ingress_count));
<a name="l00307"></a>00307 
<a name="l00308"></a>00308     <span class="keywordflow">return</span> <a class="code" href="group__error.html#ggab4c007d9d8465756b8f672c33764e6d5a549cc71e16fe086c0311d03bc995a11b">OPENNSL_E_NONE</a>;
<a name="l00309"></a>00309 }
<a name="l00310"></a>00310 <span class="comment">/* __doxy_func_body_end__ */</span>
<a name="l00311"></a>00311 
<a name="l00312"></a>00312 
<a name="l00313"></a>00313 <span class="comment">/*****************************************************************/</span>
<a name="l00320"></a><a class="code" href="xgs_2example__policer_8c.html#a0ddf1224851353fc92bfbff6f499fa97">00320</a> <span class="keywordtype">int</span> <a class="code" href="example__cos_8c.html#a0ddf1224851353fc92bfbff6f499fa97" title="Main function for policer application.">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00321"></a>00321 {
<a name="l00322"></a>00322   <span class="keywordtype">int</span> rv = 0;
<a name="l00323"></a>00323   <span class="keywordtype">int</span> unit = <a class="code" href="xgs_2example__policer_8c.html#adbb76aecfc5eef000cb4cb55bc2fd404">DEFAULT_UNIT</a>;
<a name="l00324"></a>00324 
<a name="l00325"></a>00325   <span class="comment">/* Initialize the system. */</span>
<a name="l00326"></a>00326   rv = <a class="code" href="driver_8h.html#a06a6fe41f5ea8664c461423d3cad0923" title="Function to initialize the switch.">opennsl_driver_init</a>((<a class="code" href="structopennsl__config__s.html">opennsl_init_t</a> *) <a class="code" href="sal_2types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00327"></a>00327 
<a name="l00328"></a>00328   <span class="keywordflow">if</span>(rv != <a class="code" href="group__error.html#ggab4c007d9d8465756b8f672c33764e6d5a549cc71e16fe086c0311d03bc995a11b">OPENNSL_E_NONE</a>) {
<a name="l00329"></a>00329     printf(<span class="stringliteral">&quot;\r\nFailed to initialize the system. Error: %s\r\n&quot;</span>,
<a name="l00330"></a>00330            <a class="code" href="group__error.html#ga6d47e9cb22df965b977f3810bdc0ce3e">opennsl_errmsg</a>(rv));
<a name="l00331"></a>00331     <span class="keywordflow">return</span> rv;
<a name="l00332"></a>00332   }
<a name="l00333"></a>00333 
<a name="l00334"></a>00334   <span class="comment">/* cold boot initialization commands */</span>
<a name="l00335"></a>00335   rv = <a class="code" href="examples_2util_8h.html#a2846e8ec8f46d212a3ae2493bdff7980" title="Set default configuration (like STP state, speed/duplex) for all ports.">example_port_default_config</a>(unit);
<a name="l00336"></a>00336   <span class="keywordflow">if</span> (rv != <a class="code" href="group__error.html#ggab4c007d9d8465756b8f672c33764e6d5a549cc71e16fe086c0311d03bc995a11b">OPENNSL_E_NONE</a>) {
<a name="l00337"></a>00337     printf(<span class="stringliteral">&quot;\r\nFailed to apply default config on ports, rc = %d (%s).\r\n&quot;</span>,
<a name="l00338"></a>00338            rv, <a class="code" href="group__error.html#ga6d47e9cb22df965b977f3810bdc0ce3e">opennsl_errmsg</a>(rv));
<a name="l00339"></a>00339   }
<a name="l00340"></a>00340 
<a name="l00341"></a>00341   <span class="comment">/* Add ports to default vlan. */</span>
<a name="l00342"></a>00342   printf(<span class="stringliteral">&quot;Adding ports to default vlan.\r\n&quot;</span>);
<a name="l00343"></a>00343   rv = <a class="code" href="examples_2util_8h.html#a2d14e4de1f4a7192ac7e378f8f7c63ff" title="Add all ports to default vlan.">example_switch_default_vlan_config</a>(unit);
<a name="l00344"></a>00344   <span class="keywordflow">if</span>(rv != <a class="code" href="group__error.html#ggab4c007d9d8465756b8f672c33764e6d5a549cc71e16fe086c0311d03bc995a11b">OPENNSL_E_NONE</a>) {
<a name="l00345"></a>00345     printf(<span class="stringliteral">&quot;\r\nFailed to add default ports. Error: %s\r\n&quot;</span>,
<a name="l00346"></a>00346         <a class="code" href="group__error.html#ga6d47e9cb22df965b977f3810bdc0ce3e">opennsl_errmsg</a>(rv));
<a name="l00347"></a>00347   }
<a name="l00348"></a>00348 
<a name="l00349"></a>00349   <span class="comment">/* Create policer and test traffic rate */</span>
<a name="l00350"></a>00350   rv = <a class="code" href="xgs_2example__policer_8c.html#aee65dafdf707088d43b1664bf7afeb23">example_policer_test</a>(unit);
<a name="l00351"></a>00351   <span class="keywordflow">if</span> (rv != <a class="code" href="group__error.html#ggab4c007d9d8465756b8f672c33764e6d5a549cc71e16fe086c0311d03bc995a11b">OPENNSL_E_NONE</a>) {
<a name="l00352"></a>00352     printf(<span class="stringliteral">&quot;\r\nFailed to test policer. Error: %s\r\n&quot;</span>,
<a name="l00353"></a>00353         <a class="code" href="group__error.html#ga6d47e9cb22df965b977f3810bdc0ce3e">opennsl_errmsg</a>(rv));
<a name="l00354"></a>00354   }  
<a name="l00355"></a>00355 
<a name="l00356"></a>00356   <span class="keywordflow">return</span> rv;
<a name="l00357"></a>00357 }
<a name="l00358"></a>00358 <span class="comment">/* __doxy_func_body_end__ */</span>
</pre></div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.5-->
<!-- start footer part -->


<!--BEGIN GENERATE_TREEVIEW -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->

<hr>
<p>	
<table class="footer-brcm">
	<tr>
		<td class="footer-brcm"><img src="BRCM_Red+Black_noTag_RGB.png" align=left></td>
		<td class="footer-brcm"><small><b>&copy;  2016-17 by Broadcom Limited. All rights reserved.</b></small>
			<div class="footer-brcm"><small>Broadcom Limited reserves the right to make changes without further notice to any products or data herein to improve reliability, function, or design. 
Information furnished by Broadcom Limited is believed to be accurate and reliable. However, Broadcom Limited does not assume any liability arising 
out of the application or use of this information, nor the application or use of any product or circuit described herein, neither does it convey any license 
under its patent rights nor the rights of others. </small>
			</div>
		</td>
	</tr>
</table>	
</p>	
	

</div>

<!--END GENERATE_TREEVIEW-->





</body>
</html>
