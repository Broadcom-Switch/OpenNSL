<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>OpenNSL API Guide and Reference Manual: examples/dpp/example_rx_packet_cpu.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen/doxygen_brcm.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">OpenNSL API Guide and Reference Manual
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Welcome</span></a></li>
      <li><a href="pages.html"><span>OpenNSL&#160;Documentation</span></a></li>
      <li><a href="modules.html"><span>API&#160;Reference</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">examples/dpp/example_rx_packet_cpu.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="example__rx__packet__cpu_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*********************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> *</span>
<a name="l00003"></a>00003 <span class="comment"> * (C) Copyright Broadcom Corporation 2013-2017</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> *  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a name="l00006"></a>00006 <span class="comment"> *  you may not use this file except in compliance with the License.</span>
<a name="l00007"></a>00007 <span class="comment"> *  You may obtain a copy of the License at</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> *      http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> *  Unless required by applicable law or agreed to in writing, software</span>
<a name="l00012"></a>00012 <span class="comment"> *  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a name="l00013"></a>00013 <span class="comment"> *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l00014"></a>00014 <span class="comment"> *  See the License for the specific language governing permissions and</span>
<a name="l00015"></a>00015 <span class="comment"> *  limitations under the License.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> **********************************************************************</span>
<a name="l00018"></a>00018 <span class="comment"> * \file     example_rx_packet_cpu.c</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * \brief    Example code for packet transmission</span>
<a name="l00021"></a>00021 <span class="comment"> *</span>
<a name="l00022"></a>00022 <span class="comment"> * \details  This example demonstrates the reception of a CPU bound packet.</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> ************************************************************************/</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;<a class="code" href="driver_8h.html">sal/driver.h</a>&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;<a class="code" href="version_8h.html" title="This file contains functions to get the build details.">sal/version.h</a>&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;<a class="code" href="opennsl_2error_8h.html">opennsl/error.h</a>&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;<a class="code" href="vlan_8h.html">opennsl/vlan.h</a>&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;<a class="code" href="opennsl_2port_8h.html">opennsl/port.h</a>&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;<a class="code" href="opennsl_2switch_8h.html">opennsl/switch.h</a>&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;<a class="code" href="opennsl_2pkt_8h.html">opennsl/pkt.h</a>&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;<a class="code" href="opennsl_2rx_8h.html">opennsl/rx.h</a>&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;<a class="code" href="examples_2util_8h.html">examples/util.h</a>&gt;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a><a class="code" href="example__rx__packet__cpu_8c.html#adbb76aecfc5eef000cb4cb55bc2fd404">00039</a> <span class="preprocessor">#define DEFAULT_UNIT  0</span>
<a name="l00040"></a><a class="code" href="example__rx__packet__cpu_8c.html#a91668ed1245d073a2ac84e6121205d28">00040</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_VLAN  1</span>
<a name="l00041"></a><a class="code" href="example__rx__packet__cpu_8c.html#a068278b0838b6670ab0ab0a93ed77484">00041</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_DIGITS_IN_CHOICE 5</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span>
<a name="l00043"></a><a class="code" href="example__rx__packet__cpu_8c.html#afc7d01e6dbea2c820a68fb8081c58a89">00043</a> <span class="keywordtype">char</span> <a class="code" href="example__cos_8c.html#afc7d01e6dbea2c820a68fb8081c58a89">example_usage</a>[] =
<a name="l00044"></a>00044 <span class="stringliteral">&quot;Syntax: example_rx_packet_cpu                                         \n\r&quot;</span>
<a name="l00045"></a>00045 <span class="stringliteral">&quot;                                                                      \n\r&quot;</span>
<a name="l00046"></a>00046 <span class="stringliteral">&quot;Paramaters: None.                                                     \n\r&quot;</span>
<a name="l00047"></a>00047 <span class="stringliteral">&quot;                                                                      \n\r&quot;</span>
<a name="l00048"></a>00048 <span class="stringliteral">&quot;Example: The following command is used to demonstrate receiving a     \n\r&quot;</span>
<a name="l00049"></a>00049 <span class="stringliteral">&quot;         packet to CPU.                                               \n\r&quot;</span>
<a name="l00050"></a>00050 <span class="stringliteral">&quot;         example_rx_packet_cpu                                        \n\r&quot;</span>
<a name="l00051"></a>00051 <span class="stringliteral">&quot;                                                                      \n\r&quot;</span>
<a name="l00052"></a>00052 <span class="stringliteral">&quot;Usage Guidelines: None.                                               \n\r&quot;</span>;
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="comment">/*****************************************************************/</span>
<a name="l00068"></a><a class="code" href="example__rx__packet__cpu_8c.html#a671a607f97b7c1bfb607bb8341518baa">00068</a> <span class="keywordtype">int</span> <a class="code" href="example__rx__packet__cpu_8c.html#a671a607f97b7c1bfb607bb8341518baa" title="Strip FTMH and User Header etc and get the start ethernet packet.">example_pkt_start_get</a> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> unit, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *pkt,
<a name="l00069"></a>00069                            <span class="keywordtype">int</span> len, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *user_header,
<a name="l00070"></a>00070                            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *offset)
<a name="l00071"></a>00071 {
<a name="l00072"></a>00072   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>        pph_type;
<a name="l00073"></a>00073   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>         pph_offset;
<a name="l00074"></a>00074   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>         lb_ext_offset = 0;
<a name="l00075"></a>00075   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>        eei_ext_present;
<a name="l00076"></a>00076   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>        lrn_ext_present;
<a name="l00077"></a>00077   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>        fhei_size;
<a name="l00078"></a>00078 
<a name="l00079"></a>00079   <span class="comment">/* Initialize offset to account for the FTMH base header size */</span>
<a name="l00080"></a>00080   *offset = 9;
<a name="l00081"></a>00081 
<a name="l00082"></a>00082   <span class="comment">/* Set to 1 if config property &quot;system_ftmh_load_balancing_ext_mode&quot; is *</span>
<a name="l00083"></a>00083 <span class="comment">   * defined. Otherwise, set it to zero */</span>
<a name="l00084"></a>00084   lb_ext_offset = 1;
<a name="l00085"></a>00085   *offset += lb_ext_offset;
<a name="l00086"></a>00086 
<a name="l00087"></a>00087   <span class="comment">/*</span>
<a name="l00088"></a>00088 <span class="comment">   * Need to parse the FTMH Base header to determine if Dest System Port</span>
<a name="l00089"></a>00089 <span class="comment">   * Ext(16bits) is included. This is bit 3 of the 72bit FTMH base header.</span>
<a name="l00090"></a>00090 <span class="comment">   */</span>
<a name="l00091"></a>00091   <span class="keywordflow">if</span> (pkt[8] &amp; 0x08)
<a name="l00092"></a>00092   {
<a name="l00093"></a>00093     *offset += 2;
<a name="l00094"></a>00094   }
<a name="l00095"></a>00095 
<a name="l00096"></a>00096   <span class="comment">/* Parse the PPH_TYPE in the FTMH header to see how much, *</span>
<a name="l00097"></a>00097 <span class="comment">   * if any, PPH to parse */</span>
<a name="l00098"></a>00098   pph_type = (pkt[5] &amp; 0x06) &gt;&gt; 1;
<a name="l00099"></a>00099   <span class="keywordflow">switch</span>(pph_type)
<a name="l00100"></a>00100   {
<a name="l00101"></a>00101     <span class="keywordflow">case</span> 0: <span class="comment">/* No PPH */</span>
<a name="l00102"></a>00102       pph_offset = 0;
<a name="l00103"></a>00103       <span class="keywordflow">break</span>;
<a name="l00104"></a>00104 
<a name="l00105"></a>00105     <span class="keywordflow">case</span> 1: <span class="comment">/* PPH Base */</span>
<a name="l00106"></a>00106       <span class="comment">/* PPH Base size = 56bits */</span>
<a name="l00107"></a>00107       pph_offset = 7;
<a name="l00108"></a>00108 
<a name="l00109"></a>00109       <span class="comment">/* Is EEI-Extension-Present 24bits */</span>
<a name="l00110"></a>00110       eei_ext_present = (pkt[*offset+0] &amp; 0x80) &gt;&gt; 7;
<a name="l00111"></a>00111       <span class="keywordflow">if</span> (eei_ext_present)
<a name="l00112"></a>00112       {
<a name="l00113"></a>00113         pph_offset += 3;
<a name="l00114"></a>00114       }
<a name="l00115"></a>00115 
<a name="l00116"></a>00116       <span class="comment">/* Is Learn-Extension-Present 40bits */</span>
<a name="l00117"></a>00117       lrn_ext_present = (pkt[*offset+0] &amp; 0x40) &gt;&gt; 6;
<a name="l00118"></a>00118       <span class="keywordflow">if</span> (lrn_ext_present)
<a name="l00119"></a>00119       {
<a name="l00120"></a>00120         pph_offset += 5;
<a name="l00121"></a>00121       }
<a name="l00122"></a>00122 
<a name="l00123"></a>00123       <span class="comment">/* FHEI-Size? */</span>
<a name="l00124"></a>00124       fhei_size = (pkt[*offset+0] &amp; 0x30) &gt;&gt; 4;
<a name="l00125"></a>00125       <span class="keywordflow">switch</span>(fhei_size)
<a name="l00126"></a>00126       {
<a name="l00127"></a>00127         <span class="keywordflow">case</span> 0:
<a name="l00128"></a>00128           <span class="comment">/* No fhei header */</span>
<a name="l00129"></a>00129           <span class="keywordflow">break</span>;
<a name="l00130"></a>00130         <span class="keywordflow">case</span> 1:
<a name="l00131"></a>00131           <span class="comment">/* 3 Byte fhei header */</span>
<a name="l00132"></a>00132           pph_offset += 3;
<a name="l00133"></a>00133           <span class="keywordflow">break</span>;
<a name="l00134"></a>00134         <span class="keywordflow">case</span> 2:
<a name="l00135"></a>00135           <span class="comment">/* 5 Byte fhei header */</span>
<a name="l00136"></a>00136           pph_offset += 5;
<a name="l00137"></a>00137           <span class="keywordflow">break</span>;
<a name="l00138"></a>00138         <span class="keywordflow">case</span> 3:
<a name="l00139"></a>00139           <span class="comment">/* 8 Byte fhei header */</span>
<a name="l00140"></a>00140           pph_offset += 8;
<a name="l00141"></a>00141           <span class="keywordflow">break</span>;
<a name="l00142"></a>00142       }
<a name="l00143"></a>00143       <span class="keywordflow">break</span>;
<a name="l00144"></a>00144 
<a name="l00145"></a>00145     <span class="keywordflow">case</span> 2: <span class="comment">/* PPH OAM-TS only */</span>
<a name="l00146"></a>00146       pph_offset = 0;
<a name="l00147"></a>00147       <span class="keywordflow">break</span>;
<a name="l00148"></a>00148 
<a name="l00149"></a>00149     <span class="keywordflow">case</span> 3: <span class="comment">/* PPH Base + PAM-TS */</span>
<a name="l00150"></a>00150       pph_offset = 0;
<a name="l00151"></a>00151       <span class="keywordflow">break</span>;
<a name="l00152"></a>00152    }
<a name="l00153"></a>00153 
<a name="l00154"></a>00154   *offset += pph_offset;
<a name="l00155"></a>00155 
<a name="l00156"></a>00156   <span class="keywordflow">return</span> 0;
<a name="l00157"></a>00157 }
<a name="l00158"></a>00158 <span class="comment">/* __doxy_func_body_end__ */</span>
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 <span class="comment">/*****************************************************************/</span>
<a name="l00169"></a><a class="code" href="example__rx__packet__cpu_8c.html#af30fbd034a3be7cea98089eef2b3c31d">00169</a> <a class="code" href="group__pkt.html#gad0ff17308c631605f5b442ce263f46da" title="Return values from PKT RX callout routines.">opennsl_rx_t</a> <a class="code" href="example__rx__packet__cpu_8c.html#af30fbd034a3be7cea98089eef2b3c31d" title="Packet receive callback function.">example_rx_packet_receive</a>(<span class="keywordtype">int</span> unit, <a class="code" href="structopennsl__pkt__s.html" title="Initialize a OPENNSL packet structure.">opennsl_pkt_t</a> *pkt,
<a name="l00170"></a>00170                                        <span class="keywordtype">void</span> *cookie)
<a name="l00171"></a>00171 {
<a name="l00172"></a>00172   <span class="keywordtype">int</span> i;
<a name="l00173"></a>00173   <a class="code" href="sal_2types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *data;
<a name="l00174"></a>00174   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset = 0;
<a name="l00175"></a>00175   <a class="code" href="structopennsl__pkt__s.html" title="Initialize a OPENNSL packet structure.">opennsl_pkt_t</a> pkt_l;
<a name="l00176"></a>00176   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> user_header[8];
<a name="l00177"></a>00177 
<a name="l00178"></a>00178   <span class="comment">/* print the packet received from driver */</span>
<a name="l00179"></a>00179   printf(<span class="stringliteral">&quot;Packet received with pkt-&gt;rx_port:%hhu pkt-&gt;src_port:%hhu\n&quot;</span>,
<a name="l00180"></a>00180       pkt-&gt;<a class="code" href="structopennsl__pkt__s.html#a9145f60be572ce797ead3572103fd3cf" title="Local rx port; not in HG hdr.">rx_port</a>, pkt-&gt;<a class="code" href="structopennsl__pkt__s.html#a018621bffc7eaf27e544e6355ee64cb2" title="Source port used in header/tag.">src_port</a>);
<a name="l00181"></a>00181   printf(<span class="stringliteral">&quot;Packet received with pkt-&gt;pkt_len : %d pkt-&gt;tot_len : %d cos: %d\n&quot;</span>,
<a name="l00182"></a>00182       pkt-&gt;<a class="code" href="structopennsl__pkt__s.html#ad53f3d95b59053c5c851fb66f958b985" title="Packet length according to flags.">pkt_len</a>, pkt-&gt;<a class="code" href="structopennsl__pkt__s.html#aea0ef8e00ec3bfa193b1be6e62a5dae1" title="Packet length as transmitted or received.">tot_len</a>, pkt-&gt;<a class="code" href="structopennsl__pkt__s.html#a8b74ee20ea123084b3af2ed696cd558d" title="The local COS queue to use.">cos</a>);
<a name="l00183"></a>00183 
<a name="l00184"></a>00184   data = pkt-&gt;<a class="code" href="structopennsl__pkt__s.html#a677cfa60b3e1be38bd8c32c2ba1011de" title="Pointer to array of data blocks.">pkt_data</a>-&gt;<a class="code" href="structopennsl__pkt__blk__s.html#a4b3749c9b1e57213b485f2767bb6c9ae">data</a>;
<a name="l00185"></a>00185 
<a name="l00186"></a>00186   <span class="keywordflow">for</span>(i = 0; i &lt; pkt-&gt;<a class="code" href="structopennsl__pkt__s.html#aea0ef8e00ec3bfa193b1be6e62a5dae1" title="Packet length as transmitted or received.">tot_len</a>; i++)
<a name="l00187"></a>00187   {
<a name="l00188"></a>00188     <span class="keywordflow">if</span> ((i % 4) == 0)
<a name="l00189"></a>00189       printf(<span class="stringliteral">&quot; &quot;</span>);
<a name="l00190"></a>00190     <span class="keywordflow">if</span> ((i % 32) == 0)
<a name="l00191"></a>00191       printf(<span class="stringliteral">&quot;\n\t&quot;</span>);
<a name="l00192"></a>00192 
<a name="l00193"></a>00193     printf(<span class="stringliteral">&quot;%02hhx&quot;</span>, data[i]);
<a name="l00194"></a>00194   }
<a name="l00195"></a>00195   printf(<span class="stringliteral">&quot;\n\n&quot;</span>);
<a name="l00196"></a>00196 
<a name="l00197"></a>00197   <span class="comment">/* Remove device specific header from the received packet */</span>
<a name="l00198"></a>00198   memset (&amp;pkt_l, 0x00, <span class="keyword">sizeof</span>(pkt_l));
<a name="l00199"></a>00199   <a class="code" href="example__rx__packet__cpu_8c.html#a671a607f97b7c1bfb607bb8341518baa" title="Strip FTMH and User Header etc and get the start ethernet packet.">example_pkt_start_get</a>(unit, pkt-&gt;<a class="code" href="structopennsl__pkt__s.html#a677cfa60b3e1be38bd8c32c2ba1011de" title="Pointer to array of data blocks.">pkt_data</a>-&gt;<a class="code" href="structopennsl__pkt__blk__s.html#a4b3749c9b1e57213b485f2767bb6c9ae">data</a>,
<a name="l00200"></a>00200       pkt-&gt;<a class="code" href="structopennsl__pkt__s.html#a677cfa60b3e1be38bd8c32c2ba1011de" title="Pointer to array of data blocks.">pkt_data</a>-&gt;<a class="code" href="structopennsl__pkt__blk__s.html#a8bceb369dcb292d14e89abbe00498215">len</a>,
<a name="l00201"></a>00201       user_header,
<a name="l00202"></a>00202       &amp;offset);
<a name="l00203"></a>00203 
<a name="l00204"></a>00204   memcpy (&amp;pkt_l, pkt, <span class="keyword">sizeof</span>(pkt_l));
<a name="l00205"></a>00205   pkt_l.<a class="code" href="structopennsl__pkt__s.html#a677cfa60b3e1be38bd8c32c2ba1011de" title="Pointer to array of data blocks.">pkt_data</a>-&gt;<a class="code" href="structopennsl__pkt__blk__s.html#a4b3749c9b1e57213b485f2767bb6c9ae">data</a> = &amp;pkt-&gt;<a class="code" href="structopennsl__pkt__s.html#a677cfa60b3e1be38bd8c32c2ba1011de" title="Pointer to array of data blocks.">pkt_data</a>-&gt;<a class="code" href="structopennsl__pkt__blk__s.html#a4b3749c9b1e57213b485f2767bb6c9ae">data</a>[offset];
<a name="l00206"></a>00206   pkt_l.<a class="code" href="structopennsl__pkt__s.html#aea0ef8e00ec3bfa193b1be6e62a5dae1" title="Packet length as transmitted or received.">tot_len</a>        =  pkt-&gt;<a class="code" href="structopennsl__pkt__s.html#aea0ef8e00ec3bfa193b1be6e62a5dae1" title="Packet length as transmitted or received.">tot_len</a> - offset;
<a name="l00207"></a>00207   pkt = &amp;pkt_l;
<a name="l00208"></a>00208 <span class="comment">/*  pkt-&gt;src_port = pkt-&gt;src_port - 12; */</span>
<a name="l00209"></a>00209 
<a name="l00210"></a>00210   <span class="comment">/* print the packet after removing device specific header */</span>
<a name="l00211"></a>00211   printf(<span class="stringliteral">&quot;Packet after stripping the device specific header\n&quot;</span>);
<a name="l00212"></a>00212   data = pkt-&gt;<a class="code" href="structopennsl__pkt__s.html#a677cfa60b3e1be38bd8c32c2ba1011de" title="Pointer to array of data blocks.">pkt_data</a>-&gt;<a class="code" href="structopennsl__pkt__blk__s.html#a4b3749c9b1e57213b485f2767bb6c9ae">data</a>;
<a name="l00213"></a>00213 
<a name="l00214"></a>00214   <span class="keywordflow">for</span>(i = 0; i &lt; pkt-&gt;<a class="code" href="structopennsl__pkt__s.html#aea0ef8e00ec3bfa193b1be6e62a5dae1" title="Packet length as transmitted or received.">tot_len</a>; i++)
<a name="l00215"></a>00215   {
<a name="l00216"></a>00216     <span class="keywordflow">if</span> ((i % 4) == 0)
<a name="l00217"></a>00217       printf(<span class="stringliteral">&quot; &quot;</span>);
<a name="l00218"></a>00218     <span class="keywordflow">if</span> ((i % 32) == 0)
<a name="l00219"></a>00219       printf(<span class="stringliteral">&quot;\n\t&quot;</span>);
<a name="l00220"></a>00220 
<a name="l00221"></a>00221     printf(<span class="stringliteral">&quot;%02hhx&quot;</span>, data[i]);
<a name="l00222"></a>00222   }
<a name="l00223"></a>00223 
<a name="l00224"></a>00224   printf(<span class="stringliteral">&quot;\n\n&quot;</span>);
<a name="l00225"></a>00225 
<a name="l00226"></a>00226   <span class="keywordflow">return</span> <a class="code" href="group__pkt.html#ggab3c76010359578b32d909c1a945d4e6bac213d716b61c2233015ea51594fc0ad9" title="Packet handled, not owned.">OPENNSL_RX_HANDLED</a>;
<a name="l00227"></a>00227 }
<a name="l00228"></a>00228 <span class="comment">/* __doxy_func_body_end__ */</span>
<a name="l00229"></a>00229 
<a name="l00230"></a>00230 <span class="comment">/*****************************************************************/</span>
<a name="l00237"></a><a class="code" href="example__rx__packet__cpu_8c.html#a919827c2b5cb205eb45fa3d35edbadd2">00237</a> <span class="keywordtype">int</span> <a class="code" href="example__rx__packet__cpu_8c.html#a919827c2b5cb205eb45fa3d35edbadd2" title="Setup up the system for packet reception.">example_rx_setup</a>(<span class="keywordtype">int</span> unit)
<a name="l00238"></a>00238 {
<a name="l00239"></a>00239   <span class="comment">/* RX Configuration Structure */</span>
<a name="l00240"></a>00240   <a class="code" href="structopennsl__rx__cfg__s.html" title="User-configurable, per-unit RX configuration.">opennsl_rx_cfg_t</a> rx_cfg;
<a name="l00241"></a>00241   <span class="keywordtype">int</span> rv = <a class="code" href="group__error.html#ggab4c007d9d8465756b8f672c33764e6d5a549cc71e16fe086c0311d03bc995a11b">OPENNSL_E_NONE</a>;
<a name="l00242"></a>00242   <span class="keywordtype">int</span> priority = 10;
<a name="l00243"></a>00243 
<a name="l00244"></a>00244   <a class="code" href="group__pkt.html#gaa50735c4ede253cb2c000076e416ea86" title="Initialize a OPENNSL RX configuration structure.">opennsl_rx_cfg_t_init</a>(&amp;rx_cfg);
<a name="l00245"></a>00245   rx_cfg.<a class="code" href="structopennsl__rx__cfg__s.html#a4a83dcbc13dc0cac913bf4b4a572a419" title="Default packet size.">pkt_size</a> = 16*1024;
<a name="l00246"></a>00246   rx_cfg.<a class="code" href="structopennsl__rx__cfg__s.html#aacd5a4a00d550238d23d0eceb29624b4" title="Packets per DMA chain.">pkts_per_chain</a> = 15;
<a name="l00247"></a>00247   rx_cfg.<a class="code" href="structopennsl__rx__cfg__s.html#a53ccc933ed09e1c82aca4a846b38b085" title="Global rate limiting as packets per second.">global_pps</a> = 0;
<a name="l00248"></a>00248   rx_cfg.<a class="code" href="structopennsl__rx__cfg__s.html#a87817ce92e88ad87ff2fdb806c5432a6" title="Max.">max_burst</a> = 200;
<a name="l00249"></a>00249   <span class="comment">/* Strip CRC from incoming packets          *</span>
<a name="l00250"></a>00250 <span class="comment">   * rx_cfg.flags |= OPENNSL_RX_F_CRC_STRIP;  */</span>
<a name="l00251"></a>00251   rx_cfg.<a class="code" href="structopennsl__rx__cfg__s.html#aebe86b8a9f4c2406b1acaf9dd28f1c1f" title="RX channel configuration.">chan_cfg</a>[1].<a class="code" href="structopennsl__rx__chan__cfg__s.html#a4b10562616b0b85de4abf72063757b1f" title="Number of chains (DVs) set up.">chains</a> = 4;
<a name="l00252"></a>00252   <span class="comment">/* Packets with all CoS values come through this channel */</span>
<a name="l00253"></a>00253   rx_cfg.<a class="code" href="structopennsl__rx__cfg__s.html#aebe86b8a9f4c2406b1acaf9dd28f1c1f" title="RX channel configuration.">chan_cfg</a>[1].<a class="code" href="structopennsl__rx__chan__cfg__s.html#a1c41f864fff7e061ecd74b4abcb78081" title="COS bitmap, if supported.">cos_bmp</a> = 0xFFFFFFff;
<a name="l00254"></a>00254 
<a name="l00255"></a>00255   <span class="comment">/* Register to receive packets punted to CPU */</span>
<a name="l00256"></a>00256   rv = <a class="code" href="group__pkt.html#ga34923de9f3cc0b360d07eb278a5bcb3e" title="Register or unregister to receive callbacks for received packets.">opennsl_rx_register</a>(unit, <span class="stringliteral">&quot;sample application&quot;</span>,
<a name="l00257"></a>00257       <a class="code" href="example__rx__packet__cpu_8c.html#af30fbd034a3be7cea98089eef2b3c31d" title="Packet receive callback function.">example_rx_packet_receive</a>, priority, <a class="code" href="sal_2types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="group__pkt.html#ga38b8bd3628b098ecf610bd993ca4bc17">OPENNSL_RCO_F_ALL_COS</a>);
<a name="l00258"></a>00258   <span class="keywordflow">if</span> (<a class="code" href="group__error.html#ga655eb72518850235a4c759ddceb622e6">OPENNSL_FAILURE</a>(rv))
<a name="l00259"></a>00259   {
<a name="l00260"></a>00260     printf(<span class="stringliteral">&quot;Failed to register packet receive callback for unit %d,&quot;</span>
<a name="l00261"></a>00261         <span class="stringliteral">&quot;rv = %d (%s).\r\n&quot;</span>, unit, rv, <a class="code" href="group__error.html#ga6d47e9cb22df965b977f3810bdc0ce3e">opennsl_errmsg</a>(rv));
<a name="l00262"></a>00262   }
<a name="l00263"></a>00263 
<a name="l00264"></a>00264   <span class="keywordflow">if</span> (!<a class="code" href="group__pkt.html#ga6969fbce82ce9680d1dcabe6dd14fa16" title="Boolean indication of whether RX is running on this device.">opennsl_rx_active</a>(unit))
<a name="l00265"></a>00265   {
<a name="l00266"></a>00266     rv = <a class="code" href="group__pkt.html#ga0ebab0b87f0fd6feae220c633e82d4f5" title="Start packet reception for the given device.">opennsl_rx_start</a>(unit, &amp;rx_cfg);
<a name="l00267"></a>00267     <span class="keywordflow">if</span> (<a class="code" href="group__error.html#ga655eb72518850235a4c759ddceb622e6">OPENNSL_FAILURE</a>(rv))
<a name="l00268"></a>00268     {
<a name="l00269"></a>00269       printf(<span class="stringliteral">&quot;opennsl_rx_start() failed on unit %d with rv %d (%s).\r\n&quot;</span>,
<a name="l00270"></a>00270           unit, rv, <a class="code" href="group__error.html#ga6d47e9cb22df965b977f3810bdc0ce3e">opennsl_errmsg</a>(rv));
<a name="l00271"></a>00271     }
<a name="l00272"></a>00272   }
<a name="l00273"></a>00273   <span class="keywordflow">return</span> rv;
<a name="l00274"></a>00274 }
<a name="l00275"></a>00275 <span class="comment">/* __doxy_func_body_end__ */</span>
<a name="l00276"></a>00276 
<a name="l00277"></a>00277 <span class="comment">/*****************************************************************/</span>
<a name="l00284"></a><a class="code" href="example__rx__packet__cpu_8c.html#a0ddf1224851353fc92bfbff6f499fa97">00284</a> <span class="keywordtype">int</span> <a class="code" href="example__cos_8c.html#a0ddf1224851353fc92bfbff6f499fa97" title="Main function for policer application.">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00285"></a>00285 {
<a name="l00286"></a>00286   <a class="code" href="group__error.html#gac798c5c818a3213c27d2900d47add7f9" title="OPENNSL API error codes.">opennsl_error_t</a>   rv;
<a name="l00287"></a>00287   <span class="keywordtype">int</span> unit = <a class="code" href="example__rx__packet__cpu_8c.html#adbb76aecfc5eef000cb4cb55bc2fd404">DEFAULT_UNIT</a>;
<a name="l00288"></a>00288   <span class="keywordtype">int</span> choice;
<a name="l00289"></a>00289   <span class="keywordtype">int</span> index = 0;
<a name="l00290"></a>00290   <a class="code" href="structopennsl__port__config__s.html" title="Port Configuration structure.">opennsl_port_config_t</a> pcfg;
<a name="l00291"></a>00291 
<a name="l00292"></a>00292 
<a name="l00293"></a>00293   <span class="keywordflow">if</span>(strcmp(argv[0], <span class="stringliteral">&quot;gdb&quot;</span>) == 0)
<a name="l00294"></a>00294   {
<a name="l00295"></a>00295     index = 1;
<a name="l00296"></a>00296   }
<a name="l00297"></a>00297 
<a name="l00298"></a>00298   <span class="keywordflow">if</span>((argc != (index + 1)) || ((argc &gt; (index + 1)) &amp;&amp; (strcmp(argv[index + 1], <span class="stringliteral">&quot;--help&quot;</span>) == 0)))
<a name="l00299"></a>00299   {
<a name="l00300"></a>00300     printf(<span class="stringliteral">&quot;%s\n\r&quot;</span>, <a class="code" href="example__cos_8c.html#afc7d01e6dbea2c820a68fb8081c58a89">example_usage</a>);
<a name="l00301"></a>00301     <span class="keywordflow">return</span> <a class="code" href="group__error.html#ggab4c007d9d8465756b8f672c33764e6d5a8b380efdb47b4a4b0ebafbb1c7823748">OPENNSL_E_PARAM</a>;
<a name="l00302"></a>00302   }
<a name="l00303"></a>00303 
<a name="l00304"></a>00304   <span class="comment">/* Initialize the system. */</span>
<a name="l00305"></a>00305   printf(<span class="stringliteral">&quot;Initializing the system.\r\n&quot;</span>);
<a name="l00306"></a>00306   rv = <a class="code" href="driver_8h.html#a06a6fe41f5ea8664c461423d3cad0923" title="Function to initialize the switch.">opennsl_driver_init</a>((<a class="code" href="structopennsl__config__s.html">opennsl_init_t</a> *) <a class="code" href="sal_2types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00307"></a>00307 
<a name="l00308"></a>00308   <span class="keywordflow">if</span>(rv != <a class="code" href="group__error.html#ggab4c007d9d8465756b8f672c33764e6d5a549cc71e16fe086c0311d03bc995a11b">OPENNSL_E_NONE</a>)
<a name="l00309"></a>00309   {
<a name="l00310"></a>00310     printf(<span class="stringliteral">&quot;\r\nFailed to initialize the system. Error %s\r\n&quot;</span>,
<a name="l00311"></a>00311         <a class="code" href="group__error.html#ga6d47e9cb22df965b977f3810bdc0ce3e">opennsl_errmsg</a>(rv));
<a name="l00312"></a>00312     <span class="keywordflow">return</span> rv;
<a name="l00313"></a>00313   }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315   rv = <a class="code" href="examples_2util_8h.html#a2846e8ec8f46d212a3ae2493bdff7980" title="Set default configuration (like STP state, speed/duplex) for all ports.">example_port_default_config</a>(unit);
<a name="l00316"></a>00316   <span class="keywordflow">if</span> (rv != <a class="code" href="group__error.html#ggab4c007d9d8465756b8f672c33764e6d5a549cc71e16fe086c0311d03bc995a11b">OPENNSL_E_NONE</a>)
<a name="l00317"></a>00317   {
<a name="l00318"></a>00318     printf(<span class="stringliteral">&quot;\r\nFailed to apply default config on ports, rv = %d (%s).\r\n&quot;</span>,
<a name="l00319"></a>00319            rv, <a class="code" href="group__error.html#ga6d47e9cb22df965b977f3810bdc0ce3e">opennsl_errmsg</a>(rv));
<a name="l00320"></a>00320   }
<a name="l00321"></a>00321 
<a name="l00322"></a>00322   <span class="comment">/* Add ports to default VLAN. */</span>
<a name="l00323"></a>00323   printf(<span class="stringliteral">&quot;Adding ports to default VLAN.\r\n&quot;</span>);
<a name="l00324"></a>00324   rv = <a class="code" href="examples_2util_8h.html#a2d14e4de1f4a7192ac7e378f8f7c63ff" title="Add all ports to default vlan.">example_switch_default_vlan_config</a>(unit);
<a name="l00325"></a>00325   <span class="keywordflow">if</span>(rv != <a class="code" href="group__error.html#ggab4c007d9d8465756b8f672c33764e6d5a549cc71e16fe086c0311d03bc995a11b">OPENNSL_E_NONE</a>)
<a name="l00326"></a>00326   {
<a name="l00327"></a>00327     printf(<span class="stringliteral">&quot;\r\nFailed to add default ports. rv: %s\r\n&quot;</span>, <a class="code" href="group__error.html#ga6d47e9cb22df965b977f3810bdc0ce3e">opennsl_errmsg</a>(rv));
<a name="l00328"></a>00328     <span class="keywordflow">return</span> rv;
<a name="l00329"></a>00329   }
<a name="l00330"></a>00330 
<a name="l00331"></a>00331   <span class="comment">/* Add CPU port to default VLAN */</span>
<a name="l00332"></a>00332   rv = <a class="code" href="group__port.html#ga9f95e3f27b53970914dccc70ffbe7010" title="Retrieved the port configuration for the specified device.">opennsl_port_config_get</a>(unit, &amp;pcfg);
<a name="l00333"></a>00333   <span class="keywordflow">if</span> (rv != <a class="code" href="group__error.html#ggab4c007d9d8465756b8f672c33764e6d5a549cc71e16fe086c0311d03bc995a11b">OPENNSL_E_NONE</a>) {
<a name="l00334"></a>00334     printf(<span class="stringliteral">&quot;Failed to get port configuration. Error %s\n&quot;</span>, <a class="code" href="group__error.html#ga6d47e9cb22df965b977f3810bdc0ce3e">opennsl_errmsg</a>(rv));
<a name="l00335"></a>00335     <span class="keywordflow">return</span> rv;
<a name="l00336"></a>00336   }
<a name="l00337"></a>00337 
<a name="l00338"></a>00338   rv = <a class="code" href="group__vlan.html#ga1e7cecaf6718cd174f1b1aef29349340" title="Add ports to the specified VLAN.">opennsl_vlan_port_add</a>(unit, <a class="code" href="example__rx__packet__cpu_8c.html#a91668ed1245d073a2ac84e6121205d28">DEFAULT_VLAN</a>, pcfg.<a class="code" href="structopennsl__port__config__s.html#addd32c50233821132fc7077473a53eb2" title="Mask of CPU ports.">cpu</a>, pcfg.<a class="code" href="structopennsl__port__config__s.html#addd32c50233821132fc7077473a53eb2" title="Mask of CPU ports.">cpu</a>);
<a name="l00339"></a>00339   <span class="keywordflow">if</span> (rv != <a class="code" href="group__error.html#ggab4c007d9d8465756b8f672c33764e6d5a549cc71e16fe086c0311d03bc995a11b">OPENNSL_E_NONE</a>) {
<a name="l00340"></a>00340     printf(<span class="stringliteral">&quot;Failed to add ports to VLAN. Error %s\n&quot;</span>, <a class="code" href="group__error.html#ga6d47e9cb22df965b977f3810bdc0ce3e">opennsl_errmsg</a>(rv));
<a name="l00341"></a>00341     <span class="keywordflow">return</span> rv;
<a name="l00342"></a>00342   }
<a name="l00343"></a>00343   printf(<span class="stringliteral">&quot;CPU port is added to default VLAN.\r\n&quot;</span>);
<a name="l00344"></a>00344 
<a name="l00345"></a>00345   rv = <a class="code" href="example__rx__packet__cpu_8c.html#a919827c2b5cb205eb45fa3d35edbadd2" title="Setup up the system for packet reception.">example_rx_setup</a>(unit);
<a name="l00346"></a>00346   <span class="keywordflow">if</span>(rv != <a class="code" href="group__error.html#ggab4c007d9d8465756b8f672c33764e6d5a549cc71e16fe086c0311d03bc995a11b">OPENNSL_E_NONE</a>)
<a name="l00347"></a>00347   {
<a name="l00348"></a>00348     printf(<span class="stringliteral">&quot;\r\nFailed to setup system for packet reception. rv: %s\r\n&quot;</span>,
<a name="l00349"></a>00349         <a class="code" href="group__error.html#ga6d47e9cb22df965b977f3810bdc0ce3e">opennsl_errmsg</a>(rv));
<a name="l00350"></a>00350     <span class="keywordflow">return</span> rv;
<a name="l00351"></a>00351   }
<a name="l00352"></a>00352 
<a name="l00353"></a>00353   <span class="keywordflow">while</span> (1)
<a name="l00354"></a>00354   {
<a name="l00355"></a>00355     printf(<span class="stringliteral">&quot;\r\nUser menu: Select one of the following options\r\n&quot;</span>);
<a name="l00356"></a>00356     printf(<span class="stringliteral">&quot;1. Display OpenNSL version\n&quot;</span>);
<a name="l00357"></a>00357 <span class="preprocessor">#ifdef INCLUDE_DIAG_SHELL</span>
<a name="l00358"></a>00358 <span class="preprocessor"></span>    printf(<span class="stringliteral">&quot;9. Launch diagnostic shell\n&quot;</span>);
<a name="l00359"></a>00359 <span class="preprocessor">#endif</span>
<a name="l00360"></a>00360 <span class="preprocessor"></span>    printf(<span class="stringliteral">&quot;0. Quit the application\n&quot;</span>);
<a name="l00361"></a>00361 
<a name="l00362"></a>00362     <span class="keywordflow">if</span>(<a class="code" href="examples_2util_8h.html#ad0173c952d5a8af01c14eebabc05b5df" title="Read numeric menu choice from user.">example_read_user_choice</a>(&amp;choice) != <a class="code" href="group__error.html#ggab4c007d9d8465756b8f672c33764e6d5a549cc71e16fe086c0311d03bc995a11b">OPENNSL_E_NONE</a>)
<a name="l00363"></a>00363     {
<a name="l00364"></a>00364         printf(<span class="stringliteral">&quot;Invalid option entered. Please re-enter.\n&quot;</span>);
<a name="l00365"></a>00365         <span class="keywordflow">continue</span>;
<a name="l00366"></a>00366     }
<a name="l00367"></a>00367     <span class="keywordflow">switch</span>(choice)
<a name="l00368"></a>00368     {
<a name="l00369"></a>00369       <span class="keywordflow">case</span> 1:
<a name="l00370"></a>00370       {
<a name="l00371"></a>00371         printf(<span class="stringliteral">&quot;OpenNSL version: %s\n&quot;</span>, <a class="code" href="version_8h.html#a3a64145ac66212711af67ac2e7ecc22d" title="To get the OpenNSL version.">opennsl_version_get</a>());
<a name="l00372"></a>00372         <span class="keywordflow">break</span>;
<a name="l00373"></a>00373       }
<a name="l00374"></a>00374 
<a name="l00375"></a>00375 <span class="preprocessor">#ifdef INCLUDE_DIAG_SHELL</span>
<a name="l00376"></a>00376 <span class="preprocessor"></span>      <span class="keywordflow">case</span> 9:
<a name="l00377"></a>00377       {
<a name="l00378"></a>00378         opennsl_driver_shell();
<a name="l00379"></a>00379         <span class="keywordflow">break</span>;
<a name="l00380"></a>00380       }
<a name="l00381"></a>00381 <span class="preprocessor">#endif</span>
<a name="l00382"></a>00382 <span class="preprocessor"></span>
<a name="l00383"></a>00383       <span class="keywordflow">case</span> 0:
<a name="l00384"></a>00384       {
<a name="l00385"></a>00385         printf(<span class="stringliteral">&quot;Exiting the application.\n&quot;</span>);
<a name="l00386"></a>00386         rv = <a class="code" href="driver_8h.html#aa760e8f1af45c7fd27ec014b82c572f2" title="Function to free up the resources and exit the driver.">opennsl_driver_exit</a>();
<a name="l00387"></a>00387         <span class="keywordflow">return</span> rv;
<a name="l00388"></a>00388       }
<a name="l00389"></a>00389 
<a name="l00390"></a>00390       <span class="keywordflow">default</span>:
<a name="l00391"></a>00391         <span class="keywordflow">break</span>;
<a name="l00392"></a>00392     } <span class="comment">/* End of switch */</span>
<a name="l00393"></a>00393   } <span class="comment">/* End of while */</span>
<a name="l00394"></a>00394 
<a name="l00395"></a>00395   <span class="keywordflow">return</span> <a class="code" href="group__error.html#ggab4c007d9d8465756b8f672c33764e6d5a549cc71e16fe086c0311d03bc995a11b">OPENNSL_E_NONE</a>;
<a name="l00396"></a>00396 }
<a name="l00397"></a>00397 <span class="comment">/* __doxy_func_body_end__ */</span>
</pre></div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.5-->
<!-- start footer part -->


<!--BEGIN GENERATE_TREEVIEW -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->

<hr>
<p>	
<table class="footer-brcm">
	<tr>
		<td class="footer-brcm"><img src="BRCM_Red+Black_noTag_RGB.png" align=left></td>
		<td class="footer-brcm"><small><b>&copy;  2016-17 by Broadcom Limited. All rights reserved.</b></small>
			<div class="footer-brcm"><small>Broadcom Limited reserves the right to make changes without further notice to any products or data herein to improve reliability, function, or design. 
Information furnished by Broadcom Limited is believed to be accurate and reliable. However, Broadcom Limited does not assume any liability arising 
out of the application or use of this information, nor the application or use of any product or circuit described herein, neither does it convey any license 
under its patent rights nor the rights of others. </small>
			</div>
		</td>
	</tr>
</table>	
</p>	
	

</div>

<!--END GENERATE_TREEVIEW-->





</body>
</html>
